<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Music Visualizer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéµ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            position: relative;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #login-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #1db954;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        #login-screen h1 {
            margin-bottom: 20px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #1db954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #login-btn {
            background: #1db954;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        #login-btn:hover {
            background: #1ed760;
            transform: scale(1.05);
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: none;
            width: 90%;
            max-width: 800px;
        }

        #player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        #play-pause {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }

        #track-info {
            text-align: center;
            margin-bottom: 15px;
            min-height: 50px;
        }

        #track-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #track-artist {
            font-size: 14px;
            opacity: 0.7;
        }

        #progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 15px 0;
            cursor: pointer;
            position: relative;
        }

        #progress-bar {
            height: 100%;
            background: #1db954;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        #volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        #volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        #volume-bar {
            height: 100%;
            background: #1db954;
            border-radius: 2px;
            width: 50%;
        }

        #options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        select option {
            background: #000;
        }

        #settings-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 101;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
        }

        #settings-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 101;
            background: rgba(255, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
        }

        #logout-btn:hover {
            background: rgba(255, 0, 0, 0.7);
        }

        .hidden {
            display: none !important;
        }

        #client-id-input {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #1db954;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin: 10px 0;
            width: 300px;
        }

        #client-id-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #error-message {
            color: #ff4444;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="login-screen">
        <h1>üéµ Music Visualizer</h1>
        <p>Enter your Spotify Client ID:</p>
        <input type="text" id="client-id-input" placeholder="Your Client ID">
        <br>
        <button id="login-btn">Connect to Spotify</button>
        <p style="margin-top: 20px; font-size: 12px; opacity: 0.7;">
            Make sure you're logged into Spotify in your browser first
        </p>
        <div id="error-message"></div>
    </div>

    <button id="settings-toggle">Toggle Controls</button>
    <button id="logout-btn">Logout</button>

    <div id="controls">
        <div id="track-info">
            <div id="track-name">No track playing</div>
            <div id="track-artist"></div>
        </div>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div id="player-controls">
            <button class="control-btn" id="prev-track">‚èÆ</button>
            <button class="control-btn" id="play-pause">‚ñ∂</button>
            <button class="control-btn" id="next-track">‚è≠</button>
        </div>

        <div id="volume-container">
            <span>üîä</span>
            <div id="volume-slider">
                <div id="volume-bar"></div>
            </div>
        </div>

        <div id="options">
            <select id="visualization-mode" aria-label="Visualization Mode">
                <option value="particles">Particles</option>
                <option value="bars">Frequency Bars</option>
                <option value="circular">Circular Wave</option>
                <option value="spiral">Spiral</option>
                <option value="dna">DNA Helix</option>
                <option value="kaleidoscope">Kaleidoscope</option>
            </select>

            <select id="color-theme" aria-label="Color Theme">
                <option value="spectrum">Spectrum</option>
                <option value="neon">Neon</option>
                <option value="sunset">Sunset</option>
                <option value="ocean">Ocean</option>
                <option value="fire">Fire</option>
                <option value="monochrome">Monochrome</option>
                <option value="pastel">Pastel</option>
            </select>

            <select id="sensitivity" aria-label="Sensitivity Level">
                <option value="0.5">Low Sensitivity</option>
                <option value="1" selected>Normal</option>
                <option value="1.5">High Sensitivity</option>
                <option value="2">Ultra Sensitive</option>
            </select>
        </div>
    </div>

    <!-- STEP 1: Define ALL global variables and the SDK callback FIRST -->
    <script>
        // Global variables - MUST be defined before SDK loads
        window.spotifyPlayer = null;
        window.deviceId = null;
        window.accessToken = null;
        
        // Define the SDK callback BEFORE loading the SDK
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify SDK Ready!');
            // Check if we have a pending token to initialize with
            if (window.accessToken) {
                console.log('Initializing player with saved token');
                initializeSpotifyPlayer(window.accessToken);
            }
        };

        // Function must be defined BEFORE the SDK might call it
        function initializeSpotifyPlayer(token) {
            console.log('Creating Spotify Player...');
            
            if (!window.Spotify) {
                console.error('Spotify object not found!');
                return;
            }

            window.spotifyPlayer = new Spotify.Player({
                name: 'Music Visualizer',
                getOAuthToken: cb => { 
                    console.log('Token requested by player');
                    cb(token); 
                },
                volume: 0.5
            });

            // Error handling
            window.spotifyPlayer.addListener('initialization_error', ({ message }) => {
                console.error('Failed to initialize:', message);
                document.getElementById('error-message').textContent = 'Failed to initialize player: ' + message;
            });

            window.spotifyPlayer.addListener('authentication_error', ({ message }) => {
                console.error('Failed to authenticate:', message);
                document.getElementById('error-message').textContent = 'Authentication failed. Please login again.';
                setTimeout(() => {
                    localStorage.clear();
                    window.location.reload();
                }, 2000);
            });

            window.spotifyPlayer.addListener('account_error', ({ message }) => {
                console.error('Failed to validate Spotify account:', message);
                alert('You need Spotify Premium for this visualizer to work.');
            });

            window.spotifyPlayer.addListener('playback_error', ({ message }) => {
                console.error('Failed to perform playback:', message);
            });

            // Ready
            window.spotifyPlayer.addListener('ready', ({ device_id }) => {
                console.log('Player Ready with Device ID:', device_id);
                window.deviceId = device_id;
                
                // Show success message
                const msg = 'Connected! Open Spotify and select "Music Visualizer" as your device, or use the controls below.';
                alert(msg);
                
                // Transfer playback to this device
                transferPlayback(device_id, token);
            });

            // Not Ready
            window.spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                console.log('Device has gone offline:', device_id);
            });

            // Player state changed
            window.spotifyPlayer.addListener('player_state_changed', state => {
                if (!state) return;
                
                console.log('State changed:', state);
                updatePlayerUI(state);
            });

            // Connect the player
            window.spotifyPlayer.connect().then(success => {
                console.log('Connect result:', success);
                if (!success) {
                    console.error('Failed to connect to Spotify');
                }
            });
        }

        function updatePlayerUI(state) {
            const track = state.track_window.current_track;
            if (track) {
                document.getElementById('track-name').textContent = track.name;
                document.getElementById('track-artist').textContent = track.artists.map(a => a.name).join(', ');
            }

            window.isPlaying = !state.paused;
            document.getElementById('play-pause').textContent = window.isPlaying ? '‚è∏' : '‚ñ∂';

            // Update progress
            const progress = (state.position / state.duration) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        async function transferPlayback(device_id, token) {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    body: JSON.stringify({
                        device_ids: [device_id],
                        play: false
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Transfer playback failed:', response.status);
                }
            } catch (error) {
                console.error('Transfer playback error:', error);
            }
        }
    </script>

    <!-- STEP 2: NOW load the Spotify SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <!-- STEP 3: Main application code -->
    <script>
        // Configuration
        const REDIRECT_URI = 'https://thelumm.github.io/Music-Vis/';
        const SCOPES = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-modify-playback-state',
            'user-read-playback-state'
        ];

        // Application variables
        let audioContext;
        let analyser;
        let source;
        let dataArray;
        let isPlaying = false;
        let animationId;
        let currentVisualization = 'particles';
        let currentTheme = 'spectrum';
        let sensitivity = 1;
        let particles = [];
        const maxParticles = 100;

        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Color themes
        const themes = {
            spectrum: () => {
                const time = Date.now() * 0.001;
                return `hsl(${(time * 50) % 360}, 100%, 50%)`;
            },
            neon: (intensity) => {
                const colors = ['#ff00ff', '#00ffff', '#ff00aa', '#00ff00'];
                return colors[Math.floor(Math.random() * colors.length)];
            },
            sunset: (intensity) => {
                const h = 10 + intensity * 40;
                return `hsl(${h}, 100%, ${50 + intensity * 20}%)`;
            },
            ocean: (intensity) => {
                const h = 180 + intensity * 40;
                return `hsl(${h}, 100%, ${40 + intensity * 30}%)`;
            },
            fire: (intensity) => {
                const h = intensity * 60;
                return `hsl(${h}, 100%, ${50 + intensity * 20}%)`;
            },
            monochrome: (intensity) => {
                const brightness = Math.floor(intensity * 255);
                return `rgb(${brightness}, ${brightness}, ${brightness})`;
            },
            pastel: (intensity) => {
                const h = (Date.now() * 0.05 + intensity * 100) % 360;
                return `hsl(${h}, 70%, 70%)`;
            }
        };

        // Resize canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Particle class
        class Particle {
            constructor(x, y, intensity) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 5 + intensity * 10;
                this.speedX = (Math.random() - 0.5) * intensity * 10;
                this.speedY = (Math.random() - 0.5) * intensity * 10;
                this.life = 1;
                this.decay = Math.random() * 0.02 + 0.005;
                this.intensity = intensity;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life -= this.decay;
                this.size *= 0.98;
            }

            draw(ctx, color) {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = color;
                ctx.shadowBlur = 20;
                ctx.shadowColor = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // OAuth functions
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // Login button handler
        document.getElementById('login-btn').addEventListener('click', async () => {
            const clientId = document.getElementById('client-id-input').value.trim();
            
            if (!clientId) {
                document.getElementById('error-message').textContent = 'Please enter your Spotify Client ID';
                return;
            }

            document.getElementById('error-message').textContent = '';
            
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateRandomString(16);

            localStorage.setItem('code_verifier', codeVerifier);
            localStorage.setItem('client_id', clientId);

            const args = new URLSearchParams({
                response_type: 'code',
                client_id: clientId,
                scope: SCOPES.join(' '),
                redirect_uri: REDIRECT_URI,
                state: state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });

            window.location = 'https://accounts.spotify.com/authorize?' + args;
        });

        // Check for callback
        async function handleCallback() {
            console.log('Checking for auth callback...');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('Auth error:', error);
                document.getElementById('error-message').textContent = 'Authorization failed: ' + error;
                return;
            }
            
            if (code) {
                console.log('Found auth code, exchanging for token...');
                const codeVerifier = localStorage.getItem('code_verifier');
                const clientId = localStorage.getItem('client_id');
                
                if (!codeVerifier || !clientId) {
                    console.error('Missing code verifier or client ID');
                    document.getElementById('error-message').textContent = 'Authentication error. Please try again.';
                    return;
                }
                
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier
                        })
                    });

                    const data = await response.json();
                    console.log('Token response:', data);
                    
                    if (data.access_token) {
                        localStorage.setItem('access_token', data.access_token);
                        localStorage.setItem('refresh_token', data.refresh_token || '');
                        localStorage.setItem('token_expires', Date.now() + ((data.expires_in || 3600) * 1000));
                        
                        // Clear URL parameters
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Initialize player
                        initializeApp(data.access_token);
                    } else {
                        throw new Error(data.error || 'No access token received');
                    }
                } catch (error) {
                    console.error('Token exchange failed:', error);
                    document.getElementById('error-message').textContent = 'Failed to authenticate. Please try again.';
                    localStorage.clear();
                }
            } else if (localStorage.getItem('access_token')) {
                // Check for existing token
                const tokenExpires = parseInt(localStorage.getItem('token_expires') || '0');
                const token = localStorage.getItem('access_token');
                
                if (Date.now() < tokenExpires) {
                    console.log('Using existing token');
                    initializeApp(token);
                } else {
                    console.log('Token expired');
                    localStorage.clear();
                    document.getElementById('error-message').textContent = 'Session expired. Please login again.';
                }
            }
        }

        // Initialize the app after successful auth
        function initializeApp(token) {
            console.log('Initializing app...');
            
            // Hide login screen
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('settings-toggle').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'block';
            
            // Save token globally
            window.accessToken = token;
            
            // Initialize Spotify player (if SDK is ready, otherwise it will init when ready)
            if (window.Spotify) {
                initializeSpotifyPlayer(token);
            }
            
            // Initialize visualization
            initAudioContext();
        }

        // Initialize audio context for visualization
        function initAudioContext() {
            console.log('Initializing audio context...');
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.8;
            
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            // Start animation immediately with simulated data
            animate();
        }

        // Visualization functions
        function drawParticles() {
            if (!dataArray || dataArray.length === 0) {
                dataArray = new Uint8Array(128);
            }
            
            // Simulate data for now (real audio capture requires user interaction)
            for (let i = 0; i < dataArray.length; i++) {
                dataArray[i] = Math.random() * 128 + (window.isPlaying ? 128 : 0);
            }

            // Calculate average frequency
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            const intensity = (average / 255) * sensitivity;

            // Create new particles
            if (particles.length < maxParticles && intensity > 0.1) {
                for (let i = 0; i < 3; i++) {
                    particles.push(new Particle(
                        canvas.width / 2,
                        canvas.height / 2,
                        intensity
                    ));
                }
            }

            // Update and draw particles
            particles = particles.filter(particle => particle.life > 0);
            particles.forEach(particle => {
                particle.update();
                particle.draw(ctx, themes[currentTheme](intensity));
            });
        }

        function drawBars() {
            if (!dataArray || dataArray.length === 0) {
                dataArray = new Uint8Array(128);
            }
            
            for (let i = 0; i < dataArray.length; i++) {
                dataArray[i] = Math.random() * 128 + (window.isPlaying ? 128 : 0);
            }

            const barWidth = canvas.width / dataArray.length;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height * 0.7 * sensitivity;
                const intensity = dataArray[i] / 255;
                
                ctx.fillStyle = themes[currentTheme](intensity);
                ctx.fillRect(x, canvas.height - barHeight, barWidth - 2, barHeight);
                
                // Reflection
                ctx.globalAlpha = 0.3;
                ctx.fillRect(x, canvas.height - barHeight - 10, barWidth - 2, -barHeight * 0.3);
                ctx.globalAlpha = 1;
                
                x += barWidth;
            }
        }

        function drawCircular() {
            if (!dataArray || dataArray.length === 0) {
                dataArray = new Uint8Array(128);
            }
            
            for (let i = 0; i < dataArray.length; i++) {
                dataArray[i] = Math.random() * 128 + (window.isPlaying ? 128 : 0);
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.3;

            ctx.save();
            ctx.translate(centerX, centerY);
            
            for (let i = 0; i < dataArray.length; i++) {
                const angle = (i / dataArray.length) * Math.PI * 2;
                const intensity = dataArray[i] / 255;
                const barHeight = intensity * 200 * sensitivity;
                
                ctx.save();
                ctx.rotate(angle);
                ctx.fillStyle = themes[currentTheme](intensity);
                ctx.fillRect(radius, -2, barHeight, 4);
                ctx.restore();
            }
            
            ctx.restore();
        }

        function drawSpiral() {
            if (!dataArray || dataArray.length === 0) {
                dataArray = new Uint8Array(128);
            }
            
            for (let i = 0; i < dataArray.length; i++) {
                dataArray[i] = Math.random() * 128 + (window.isPlaying ? 128 : 0);
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const time = Date.now() * 0.001;

            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(time * 0.5);

            for (let i = 0; i < dataArray.length; i++) {
                const angle = (i / dataArray.length) * Math.PI * 4;
                const intensity = dataArray[i] / 255;
                const radius = i * 3 + intensity * 100 * sensitivity;
                
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                
                ctx.fillStyle = themes[currentTheme](intensity);
                ctx.beginPath();
                ctx.arc(x, y, 3 + intensity * 5, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }

        function drawDNA() {
            if (!dataArray || dataArray.length === 0) {
                dataArray = new Uint8Array(128);
            }
            
            for (let i = 0; i < dataArray.length; i++) {
                dataArray[i] = Math.random() * 128 + (window.isPlaying ? 128 : 0);
            }

            const centerX = canvas.width / 2;
            const time = Date.now() * 0.001;

            for (let i = 0; i < dataArray.length; i++) {
                const y = (i / dataArray.length) * canvas.height;
                const intensity = dataArray[i] / 255;
                const amplitude = intensity * 200 * sensitivity;
                
                const x1 = centerX + Math.sin(y * 0.01 + time) * amplitude;
                const x2 = centerX - Math.sin(y * 0.01 + time) * amplitude;
                
                ctx.fillStyle = themes[currentTheme](intensity);
                ctx.beginPath();
                ctx.arc(x1, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(x2, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Connect with line
                ctx.strokeStyle = themes[currentTheme](intensity * 0.5);
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.moveTo(x1, y);
                ctx.lineTo(x2, y);
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
        }

        function drawKaleidoscope() {
            if (!dataArray || dataArray.length === 0) {
                dataArray = new Uint8Array(128);
            }
            
            for (let i = 0; i < dataArray.length; i++) {
                dataArray[i] = Math.random() * 128 + (window.isPlaying ? 128 : 0);
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const time = Date.now() * 0.001;
            const segments = 8;

            ctx.save();
            ctx.translate(centerX, centerY);

            for (let s = 0; s < segments; s++) {
                ctx.save();
                ctx.rotate((s / segments) * Math.PI * 2);
                
                for (let i = 0; i < dataArray.length / 4; i++) {
                    const intensity = dataArray[i] / 255;
                    const radius = i * 10 + intensity * 50 * sensitivity;
                    const angle = time + i * 0.1;
                    
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    ctx.fillStyle = themes[currentTheme](intensity);
                    ctx.globalAlpha = intensity;
                    ctx.fillRect(x, y, 5, 5);
                }
                
                ctx.restore();
            }
            
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        // Main animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);

            // Fade effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw based on selected visualization
            switch(currentVisualization) {
                case 'particles':
                    drawParticles();
                    break;
                case 'bars':
                    drawBars();
                    break;
                case 'circular':
                    drawCircular();
                    break;
                case 'spiral':
                    drawSpiral();
                    break;
                case 'dna':
                    drawDNA();
                    break;
                case 'kaleidoscope':
                    drawKaleidoscope();
                    break;
            }
        }

        // Control event listeners
        document.getElementById('play-pause').addEventListener('click', () => {
            if (window.spotifyPlayer) {
                window.spotifyPlayer.togglePlay();
            }
        });

        document.getElementById('prev-track').addEventListener('click', () => {
            if (window.spotifyPlayer) {
                window.spotifyPlayer.previousTrack();
            }
        });

        document.getElementById('next-track').addEventListener('click', () => {
            if (window.spotifyPlayer) {
                window.spotifyPlayer.nextTrack();
            }
        });

        document.getElementById('progress-container').addEventListener('click', async (e) => {
            if (!window.spotifyPlayer) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = x / rect.width;
            
            const state = await window.spotifyPlayer.getCurrentState();
            if (state) {
                const position = state.duration * percentage;
                window.spotifyPlayer.seek(position);
            }
        });

        document.getElementById('volume-slider').addEventListener('click', (e) => {
            if (!window.spotifyPlayer) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = x / rect.width;
            
            window.spotifyPlayer.setVolume(percentage);
            document.getElementById('volume-bar').style.width = (percentage * 100) + '%';
        });

        document.getElementById('visualization-mode').addEventListener('change', (e) => {
            currentVisualization = e.target.value;
        });

        document.getElementById('color-theme').addEventListener('change', (e) => {
            currentTheme = e.target.value;
        });

        document.getElementById('sensitivity').addEventListener('change', (e) => {
            sensitivity = parseFloat(e.target.value);
        });

        document.getElementById('settings-toggle').addEventListener('click', () => {
            document.getElementById('controls').classList.toggle('hidden');
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.clear();
            window.location.reload();
        });

        // Update progress periodically
        setInterval(async () => {
            if (window.spotifyPlayer && window.isPlaying) {
                const state = await window.spotifyPlayer.getCurrentState();
                if (state) {
                    const progress = (state.position / state.duration) * 100;
                    document.getElementById('progress-bar').style.width = progress + '%';
                }
            }
        }, 1000);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            handleCallback();
        });
    </script>
</body>
</html>
